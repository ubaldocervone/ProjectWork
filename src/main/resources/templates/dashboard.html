<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title th:text="${pageTitle} ?: 'Dashboard'">Dashboard</title>

  <!-- (opzionale) tuo css statico: src/main/resources/static/css/app.css -->
  <link rel="stylesheet" href="/css/app.css"/>

  <!-- Bootstrap per layout veloce (opzionale, puoi rimuoverlo se non ti serve) -->
  <link
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous"
  />

  <style>
    /* Stili minimi nel caso non usi /css/app.css */
    body { background:#0f172a; color:#e2e8f0; }
    .brand        { font-weight:700; letter-spacing:.5px; }
    .card-kpi     { background:#111827; border:1px solid #1f2937; border-radius:14px; }
    .kpi-label    { color:#9ca3af; font-size:.9rem; }
    .kpi-value    { font-size:1.8rem; font-weight:700; }
    .panel        { background:#0b1220; border:1px solid #1f2937; border-radius:14px; }
    .panel h5     { color:#cbd5e1; }
    .nav-pill a   { color:#94a3b8; text-decoration:none; padding:.5rem .75rem; display:block; border-radius:10px; }
    .nav-pill a.active, .nav-pill a:hover { background:#1f2937; color:#e2e8f0; }
    .table thead th { color:#a1a1aa; font-weight:600; border-bottom-color:#1f2937; }
    .table tbody td { color:#e5e7eb; border-top-color:#1f2937; }
    canvas { max-height: 360px; }
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
</head>

<!-- Defaults con th:with per evitare "Cannot resolve ${...}" -->
<body th:with="
  pageTitle = ${pageTitle} ?: 'Dashboard',
  errorMsg  = ${errorMsg}  ?: '',
  labels    = ${labels}    ?: ${#lists.emptyList()},
  tempData  = ${tempData}  ?: ${#lists.emptyList()},
  humData   = ${humData}   ?: ${#lists.emptyList()},
  rainData  = ${rainData}  ?: ${#lists.emptyList()},
  prezziLabels = ${prezziLabels} ?: ${#lists.emptyList()},
  prezziData   = ${prezziData}   ?: ${#lists.emptyList()},
  kpiTemp   = ${kpiTemp}   ?: 0,
  kpiHum    = ${kpiHum}    ?: 0,
  kpiRain   = ${kpiRain}   ?: 0,
  kpiPrezzi = ${kpiPrezzi} ?: 0
">
<!-- HEADER / NAV -->
<header class="container-fluid py-3 border-bottom border-secondary">
  <div class="container d-flex align-items-center justify-content-between">
    <div class="brand d-flex align-items-center gap-2">
      <img src="https://img.icons8.com/ios-glyphs/30/ffffff/combo-chart.png" alt="logo" />
      <span th:text="${pageTitle}">Dashboard</span>
    </div>
    <nav class="d-flex gap-2 nav-pill">
      <a href="/" class="active">Dashboard</a>
      <a href="/api/health">API</a>
    </nav>
  </div>
</header>

<main class="container py-4">

  <!-- ALERT ERRORE -->
  <div class="alert alert-warning panel" role="alert" th:if="${errorMsg} != null and ${errorMsg} != ''">
    <strong>Attenzione:</strong> <span th:text="${errorMsg}">Errore caricamento dati</span>
  </div>

  <!-- KPI -->
  <section class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="card-kpi p-3 h-100">
        <div class="kpi-label">Temperatura media (°C)</div>
        <div class="kpi-value" th:text="${#numbers.formatDecimal(kpiTemp, 1, 1)}">0.0</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card-kpi p-3 h-100">
        <div class="kpi-label">Umidità media (%)</div>
        <div class="kpi-value" th:text="${#numbers.formatDecimal(kpiHum, 1, 1)}">0.0</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card-kpi p-3 h-100">
        <div class="kpi-label">Pioggia (mm tot)</div>
        <div class="kpi-value" th:text="${#numbers.formatDecimal(kpiRain, 1, 1)}">0.0</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card-kpi p-3 h-100">
        <div class="kpi-label">Indice Prezzi (ultimo)</div>
        <div class="kpi-value" th:text="${#numbers.formatDecimal(kpiPrezzi, 1, 1)}">0.0</div>
      </div>
    </div>
  </section>

  <!-- CHARTS -->
  <section class="row g-4">
    <div class="col-12 col-lg-7">
      <div class="panel p-3">
        <h5 class="mb-3">Andamento Meteo</h5>
        <canvas id="meteoChart" aria-label="Grafico meteo"></canvas>
      </div>
    </div>
    <div class="col-12 col-lg-5">
      <div class="panel p-3">
        <h5 class="mb-3">Indice Prezzi</h5>
        <canvas id="prezziChart" aria-label="Grafico prezzi"></canvas>
      </div>
    </div>
  </section>

  <!-- TABELLA RIASSUNTO (opzionale) -->
  <section class="panel p-3 mt-4">
    <h5 class="mb-3">Riassunto elementi</h5>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
        <tr>
          <th>Mese</th>
          <th>Temp (°C)</th>
          <th>Umidità (%)</th>
          <th>Pioggia (mm)</th>
          <th>Indice Prezzi</th>
        </tr>
        </thead>
        <tbody>
        <!-- Rende la tabella anche se le liste hanno lunghezze diverse -->
        <tr th:each="i : ${#numbers.sequence(0, (labels.size() ?: 0) - 1)}">
          <td th:text="${labels[i]}">—</td>
          <td th:text="${(i < tempData.size()) ? #numbers.formatDecimal(tempData[i],1,1) : ''}">—</td>
          <td th:text="${(i < humData.size())  ? #numbers.formatDecimal(humData[i],1,1)  : ''}">—</td>
          <td th:text="${(i < rainData.size()) ? #numbers.formatDecimal(rainData[i],1,1) : ''}">—</td>
          <td th:text="${(i < prezziData.size()) ? #numbers.formatDecimal(prezziData[i],1,1) : ''}">—</td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>
</main>

<!-- Variabili JS dal Model -->
<script th:inline="javascript">
  const LABELS       = /*[[${labels}]]*/ [];
  const TEMP_DATA    = /*[[${tempData}]]*/ [];
  const HUM_DATA     = /*[[${humData}]]*/ [];
  const RAIN_DATA    = /*[[${rainData}]]*/ [];
  const PREZZI_LABELS= /*[[${prezziLabels}]]*/ [];
  const PREZZI_DATA  = /*[[${prezziData}]]*/ [];

  // Fallback se le etichette prezzi non arrvano: riusa LABELS
  const PRZ_LABELS = PREZZI_LABELS && PREZZI_LABELS.length ? PREZZI_LABELS : LABELS;

  // Utilità: crea dataset con uno stile semplice
  const ds = (label, data, type='line') => ({
    label, data, type, tension: 0.3, pointRadius: 2, borderWidth: 2, fill: false
  });

  // METEO: temp (linea), hum (linea), rain (barre)
  const meteoCtx = document.getElementById('meteoChart').getContext('2d');
  new Chart(meteoCtx, {
    data: {
      labels: LABELS,
      datasets: [
        ds('Temperatura (°C)', TEMP_DATA, 'line'),
        ds('Umidità (%)',      HUM_DATA,  'line'),
        { ...ds('Pioggia (mm)', RAIN_DATA, 'bar'), borderWidth: 0 }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: '#e5e7eb' } } },
      scales: {
        x: { ticks:{ color:'#94a3b8' }, grid:{ color:'#1f2937' } },
        y: { ticks:{ color:'#94a3b8' }, grid:{ color:'#1f2937' } }
      }
    }
  });

  // PREZZI: linea semplice
  const prezziCtx = document.getElementById('prezziChart').getContext('2d');
  new Chart(prezziCtx, {
    type: 'line',
    data: {
      labels: PRZ_LABELS,
      datasets: [ ds('Indice Prezzi', PREZZI_DATA, 'line') ]
    },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: '#e5e7eb' } } },
      scales: {
        x: { ticks:{ color:'#94a3b8' }, grid:{ color:'#1f2937' } },
        y: { ticks:{ color:'#94a3b8' }, grid:{ color:'#1f2937' } }
      }
    }
  });
</script>

<!-- (opzionale) tuo js statico: src/main/resources/static/js/app.js -->
<script src="/js/app.js"></script>
</body>
</html>
